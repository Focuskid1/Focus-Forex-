<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Enhanced Forex Signals Dashboard with Push Notifications">
  <meta name="theme-color" content="#1e3a8a" />
  <meta property="og:title" content="Forex Signals Dashboard" />
  <meta property="og:description" content="Real-time Forex trade signals with push notifications" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-928H5BZ433"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-928H5BZ433');
</script>
  <title>Forex Signals Dashboard - Push Notifications</title>
  
  <!-- Libraries from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  
  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  
  <!-- Service Worker for notifications -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log("‚úÖ Service Worker registered:", reg))
        .catch(err => console.error("‚ùå SW registration failed:", err));
    }
  </script>
  
  <style>
    .notification-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s ease-in-out;
    }
    .notification-toast.show {
      transform: translateX(0);
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .notification-bell {
      animation: ring 1s ease-in-out;
    }
    @keyframes ring {
      0%, 20%, 50%, 80%, 100% { transform: rotate(0deg); }
      10% { transform: rotate(10deg); }
      30% { transform: rotate(-10deg); }
      60% { transform: rotate(5deg); }
      70% { transform: rotate(-5deg); }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-900 to-indigo-900 min-h-screen text-white"> 

  <!-- Notification Toast -->
  <div id="notificationToast" class="notification-toast bg-green-600 text-white p-4 rounded-lg shadow-lg max-w-sm">
    <div class="flex items-center">
      <i class="fas fa-bell mr-2"></i>
      <div>
        <div class="font-semibold" id="toastTitle">New Signal!</div>
        <div class="text-sm" id="toastMessage">Check your dashboard for updates</div>
      </div>
      <button onclick="hideNotification()" class="ml-4 text-white hover:text-gray-200">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
      <p class="text-xl">Initializing notifications...</p>
      <p class="text-sm text-gray-300 mt-2">Setting up real-time alerts</p>
    </div>
  </div>

  <!-- Login Required Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center">
        <div class="text-red-500 text-6xl mb-4"><i class="fas fa-lock"></i></div>
        <h2 class="text-2xl font-bold mb-4">Access Denied</h2>
        <p class="text-gray-300 mb-6">You must be logged in to access this dashboard.</p>
      </div>
    </div>
  </div>

  <!-- Login Form -->
  <div id="loginForm" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
    <button onclick="history.back()" class="fixed top-4 left-4 z-50 flex items-center gap-2 bg-gradient-to-r from-gray-700 to-gray-800 text-white px-5 py-2 rounded-full shadow-md hover:shadow-xl hover:from-gray-600 hover:to-gray-700 transition duration-200">
      <i class="fas fa-arrow-left"></i> Back
    </button>
    
    <div class="bg-gray-900 p-8 rounded-lg shadow-xl w-full max-w-md">
      <h2 class="text-2xl font-bold text-white text-center mb-4">
        <i class="fas fa-shield-alt mr-2"></i>Login
      </h2>
      <p class="text-center text-sm text-gray-300 mt-4">
        Don't have login credentials? <br />
        Please <a href="mailto:chibuikeedomani@gmail.com" class="text-blue-400 underline hover:text-blue-600">email us</a> to request access.
      </p>
      <form id="authForm" class="space-y-4">
        <input type="email" id="email" placeholder="Email" required class="w-full px-4 py-3 rounded bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3 rounded bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
        <label class="inline-flex items-center text-sm text-gray-300">
          <input type="checkbox" id="rememberMe" class="mr-2"> Remember me
        </label>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded text-white font-bold transition duration-200">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
      </form>
    </div>
  </div>

  <!-- Notification Permission Modal -->
  <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center">
        <div class="text-yellow-500 text-6xl mb-4"><i class="fas fa-bell"></i></div>
        <h2 class="text-2xl font-bold mb-4">Enable Notifications</h2>
        <p class="text-gray-300 mb-6">Get instant alerts when new trading signals are available.</p>
        <div class="flex space-x-4">
          <button id="enableNotifications" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded text-white font-bold transition duration-200">
            <i class="fas fa-check mr-2"></i>Enable
          </button>
          <button id="skipNotifications" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded text-white font-bold transition duration-200">
            <i class="fas fa-times mr-2"></i>Skip
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div id="dashboardContent" class="max-w-6xl mx-auto p-6 hidden">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8"> 
      <div>
        <h1 class="text-3xl font-bold">
          <i class="fas fa-chart-line mr-2 text-blue-400"></i>FOCUS SIGNALS
        </h1>
        <br>
        <p id="userInfo" class="text-sm text-gray-300 mt-1"></p>
        <div class="flex items-center mt-2">
          <span class="text-xs text-gray-400 mr-2">Notifications:</span>
          <span id="notificationStatus" class="text-xs px-2 py-1 rounded bg-gray-700">
            <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
          </span>
        </div>
      </div>
      <div class="flex space-x-3">
        <!-- Notification Bell -->
        <button id="notificationBell" class="relative bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-full shadow-lg transform transition duration-200 hover:scale-105">
          <i class="fas fa-bell"></i>
          <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </button>
        
<button id="logoutBtn" class="flex items-center bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-medium px-3 py-1 rounded-full shadow-lg transform transition duration-200 hover:scale-105 text-sm">
  <i class="fas fa-sign-out-alt mr-1"></i> Logout
</button>
      </div>
    </div>
    
    <hr class="border-gray-600 mb-8">

    <!-- Session Warning -->
    <div id="sessionWarning" class="bg-yellow-800 border border-yellow-600 text-yellow-200 px-4 py-3 rounded mb-6 hidden">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span>Your session will expire soon. Please refresh to continue.</span>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-r from-green-600 to-green-700 p-4 rounded-lg shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-100 text-sm">Active Signals</p>
            <p class="text-2xl font-bold" id="activeSignals">0</p>
          </div>
          <i class="fas fa-signal text-3xl text-green-200"></i>
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 rounded-lg shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100 text-sm">Today's Signals</p>
            <p class="text-2xl font-bold" id="todaySignals">0</p>
          </div>
          <i class="fas fa-calendar-day text-3xl text-blue-200"></i>
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-purple-600 to-purple-700 p-4 rounded-lg shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-100 text-sm">Success Rate</p>
            <p class="text-2xl font-bold" id="successRate">0%</p>
          </div>
          <i class="fas fa-percentage text-3xl text-purple-200"></i>
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-orange-600 to-orange-700 p-4 rounded-lg shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-100 text-sm">Live Status</p>
            <p class="text-sm font-bold" id="liveStatus">
              <i class="fas fa-circle text-green-400 mr-1"></i>Connected
            </p>
          </div>
          <i class="fas fa-wifi text-3xl text-orange-200"></i>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h3 class="text-xl font-bold mb-4">
        <i class="fas fa-chart-area mr-2 text-blue-400"></i>Signal Performance
      </h3>
      <div style="height: 300px; position: relative;">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>

    <!-- Signals List -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">
          <i class="fas fa-list mr-2 text-blue-400"></i>Recent Signals
        </h3>
        <div class="flex space-x-2">
          <button id="refreshSignals" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm transition duration-200">
            <i class="fas fa-sync-alt mr-1"></i>Refresh
          </button>
          <select id="filterStatus" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
            <option value="">All Signals</option>
            <option value="BUY">Buy Only</option>
            <option value="SELL">Sell Only</option>
            <option value="PENDING">Pending Only</option>
          </select>
        </div>
      </div>
      
      <div id="signalsList" class="grid md:grid-cols-2 gap-6"></div>
      <p id="lastUpdated" class="text-sm mt-6 text-gray-300 text-center"></p>
    </div>
  </div>

  <!-- Audio for notifications -->
  <audio id="notificationSound" preload="auto">
    <source src="notify.mp3" type="audio/mp3">
  </audio>

  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
      OneSignal.SERVICE_WORKER_PATH = "/sw.js";
      OneSignal.init({
        appId: "4b7e9e82-e22e-43d4-aeb9-9f3f8e96fbcf",
        notifyButton: { enable: true },
        allowLocalhostAsSecureOrigin: true
      });

      OneSignal.showSlidedownPrompt();

      OneSignal.isPushNotificationsEnabled(function(enabled) {
        console.log("Push notifications enabled:", enabled);
      });

      OneSignal.on('notificationDisplay', function(event) {
        console.log('üîî Notification displayed:', event);
        const audio = document.getElementById('notificationSound');
        if (audio) audio.play();
      });
    });
  </script>

  <script>
    // Global Configuration
    const SUPABASE_URL = "https://addgnnpugkwfhznmegfb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkZGdubnB1Z2t3Zmh6bm1lZ2ZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NjEyMTMsImV4cCI6MjA2ODUzNzIxM30.rWwuSAPWhxm-7Ju4CkGzGiFbbOhzzlqFCV4gGTa2DII";
    const ONESIGNAL_APP_ID = "fab53d7e-3f76-4692-b6fc-24a778101ef4";
    
    // Initialize Supabase
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global Variables
    let currentUser = null;
    let sessionCheckInterval = null;
    let signalsSubscription = null;
    let performanceChart = null;
    let notificationCount = 0;
    let isNotificationsEnabled = false;
    let lastSignalId = null;

    // OneSignal Configuration
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: ONESIGNAL_APP_ID,
        notifyButton: { enable: false },
        allowLocalhostAsSecureOrigin: true,
      });

      const isSubscribed = await OneSignal.Notifications.permission;
      updateNotificationStatus(isSubscribed === 'granted');
      
      OneSignal.Notifications.addEventListener('permissionChange', function(permission) {
        updateNotificationStatus(permission);
      });
    });

    // Notification Functions
    function updateNotificationStatus(enabled) {
      isNotificationsEnabled = enabled;
      const statusElement = document.getElementById('notificationStatus');
      const bellElement = document.getElementById('notificationBell');
      
      if (enabled) {
        statusElement.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-1"></i>Enabled';
        statusElement.className = 'text-xs px-2 py-1 rounded bg-green-700';
        bellElement.className = bellElement.className.replace('bg-gray-600', 'bg-blue-600');
      } else {
        statusElement.innerHTML = '<i class="fas fa-times-circle text-red-400 mr-1"></i>Disabled';
        statusElement.className = 'text-xs px-2 py-1 rounded bg-red-700';
        bellElement.className = bellElement.className.replace('bg-blue-600', 'bg-gray-600');
      }
    }

    async function requestNotificationPermission() {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.Notifications.requestPermission();
          });
          updateNotificationStatus(true);
          document.getElementById('notificationModal').classList.add('hidden');
          return true;
        }
      }
      return false;
    }

    function showNotificationToast(title, message, type = 'info') {
      const toast = document.getElementById('notificationToast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      
      const baseClass = 'notification-toast p-4 rounded-lg shadow-lg max-w-sm';
      switch(type) {
        case 'success':
          toast.className = baseClass + ' bg-green-600 text-white';
          break;
        case 'error':
          toast.className = baseClass + ' bg-red-600 text-white';
          break;
        case 'warning':
          toast.className = baseClass + ' bg-yellow-600 text-white';
          break;
        default:
          toast.className = baseClass + ' bg-blue-600 text-white';
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }

    function hideNotification() {
      document.getElementById('notificationToast').classList.remove('show');
    }

    function playNotificationSound() {
      const audio = document.getElementById('notificationSound');
      if (audio && isNotificationsEnabled) {
        audio.play().catch(e => console.log('Could not play notification sound:', e));
      }
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      const bell = document.getElementById('notificationBell');
      
      if (notificationCount > 0) {
        badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
        badge.classList.remove('hidden');
        bell.classList.add('notification-bell');
        setTimeout(() => bell.classList.remove('notification-bell'), 1000);
      } else {
        badge.classList.add('hidden');
      }
    }

    // Auth Functions
    async function checkAuth() {
      const { data: { session }, error } = await client.auth.getSession();
      if (error || !session || !session.user) {
        if (localStorage.getItem('rememberUser')) {
          document.getElementById('loginForm').classList.remove('hidden');
        } else {
          showLoginRequired();
        }
        return false;
      }

      const now = Date.now() / 1000;
      const expiry = session.expires_at;
      const timeUntilExpiry = expiry - now;

      if (timeUntilExpiry < 600) {
        document.getElementById('sessionWarning').classList.remove('hidden');
      }

      currentUser = session.user;
      document.getElementById('userInfo').innerHTML = `<i class="fas fa-user mr-1"></i>Welcome, ${currentUser.email}`;
      return true;
    }

    function showLoginRequired() {
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function showDashboard() {
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('notificationModal').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      
      initializeDashboard();
    }

    function cleanupSubscriptions() {
      if (signalsSubscription) {
        signalsSubscription.unsubscribe();
        signalsSubscription = null;
      }
      if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
        sessionCheckInterval = null;
      }
    }

    // Dashboard Functions
    async function initializeDashboard() {
      await fetchSignals();
      setupRealTimeSubscription();
      initializeChart();
      updateStatistics();
      
      sessionCheckInterval = setInterval(checkAuth, 300000);
      setInterval(updateStatistics, 30000);
    }

    function initializeChart() {
      const ctx = document.getElementById('performanceChart');
      if (!ctx) return;
      
      // üî• DESTROY PREVIOUS CHART IF EXISTS
  if (performanceChart) {
    performanceChart.destroy();
  }
  
      
      
      try {
        performanceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
             datasets: [{
              label: 'Successful Signals',
              data: [12, 19, 8, 15, 22],
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            }, {
              label: 'Total Signals',
              data: [15, 25, 12, 20, 28],
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                labels: { 
                  color: '#ffffff',
                  usePointStyle: true,
                  padding: 20
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#ffffff',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { 
                  color: '#ffffff',
                  callback: function(value) {
                    return Number.isInteger(value) ? value : '';
                  }
                },
                grid: { 
                  color: 'rgba(255, 255, 255, 0.1)',
                  drawBorder: false
                }
              },
              x: {
                ticks: { color: '#ffffff' },
                grid: { 
                  color: 'rgba(255, 255, 255, 0.1)',
                  drawBorder: false
                }
              }
            },
            elements: {
              point: {
                radius: 4,
                hoverRadius: 6
              }
            }
          }
        });
      } catch (error) {
        console.error('Chart initialization error:', error);
        document.getElementById('performanceChart').parentElement.innerHTML = '<p class="text-center text-gray-400">Chart unavailable</p>';
      }
    }

    async function fetchSignals() {
      const { data: { session } } = await client.auth.getSession();
      if (!session || !session.user) {
        showLoginRequired();
        return;
      }

      const container = document.getElementById('signalsList');
      const lastUpdated = document.getElementById('lastUpdated');
      const filterStatus = document.getElementById('filterStatus').value;
      
      container.innerHTML = '<div class="col-span-full text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div><p class="mt-2">Loading signals...</p></div>';

      try {
        let query = client.from('focus').select('*').order('created_at', { ascending: false });
        
        if (filterStatus) {
          query = query.eq('status', filterStatus);
        }

        const { data, error } = await query;
        container.innerHTML = '';

        if (error) {
          console.error('Fetch error:', error);
          container.innerHTML = "<div class='col-span-full bg-red-800 p-4 rounded'><p class='text-red-200'><i class='fas fa-exclamation-triangle mr-2'></i>Failed to load signals. Please try again.</p></div>";
          return;
        }

        if (data.length === 0) {
          container.innerHTML = "<div class='col-span-full bg-yellow-800 p-4 rounded'><p class='text-yellow-200'><i class='fas fa-info-circle mr-2'></i>No signals available at this time.</p></div>";
          return;
        }

        data.forEach((signal, index) => {
          const card = document.createElement('div');
          card.className = `bg-gray-700 text-white p-5 rounded-lg shadow-lg border border-gray-600 hover:scale-[1.02] transition transform ${index === 0 ? 'pulse-animation' : ''}`;

          const statusColor = signal.status?.toUpperCase() === "BUY" ? "bg-green-600" :
                              signal.status?.toUpperCase() === "SELL" ? "bg-red-600" : "bg-yellow-500";

          const statusIcon = signal.status?.toUpperCase() === "BUY" ? "fas fa-arrow-up" :
                            signal.status?.toUpperCase() === "SELL" ? "fas fa-arrow-down" : "fas fa-clock";

          card.innerHTML = `
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-xl font-bold flex items-center">
                <i class="fas fa-chart-line mr-2 text-blue-400"></i>${signal.pair}
              </h2>
              <span class="text-xs px-3 py-1 rounded-full ${statusColor} font-semibold flex items-center">
                <i class="${statusIcon} mr-1"></i>${signal.status || "PENDING"}
              </span>
            </div>
            <div class="space-y-2">
              <p class="flex justify-between">
                <span class="text-gray-300">Entry:</span> 
                <span class="font-semibold">${signal.entry}</span>
              </p>
              <p class="flex justify-between">
                <span class="text-gray-300">Stop Loss:</span> 
                <span class="font-semibold text-red-400">${signal.stop_loss}</span>
              </p>
              <p class="flex justify-between">
                <span class="text-gray-300">Take Profit:</span> 
                <span class="font-semibold text-green-400">${signal.take_profit}</span>
              </p>
              <div class="mt-3 pt-3 border-t border-gray-600">
                <p class="text-sm text-gray-400 flex items-center">
                  <i class="fas fa-calendar mr-1"></i>
                  ${formatTime(signal.created_at)} (${timeAgo(signal.created_at)})
                </p>
              </div>
            </div>
          `;

          container.appendChild(card);
        });

        lastUpdated.innerHTML = `<i class="fas fa-sync-alt mr-1"></i>Last updated: ${new Date().toLocaleTimeString()}`;
        document.getElementById('sessionWarning').classList.add('hidden');
        
        if (data.length > 0 && lastSignalId && data[0].id !== lastSignalId) {
          handleNewSignal(data[0]);
        }
        if (data.length > 0) {
          lastSignalId = data[0].id;
        }
        
      } catch (error) {
        console.error('Network error:', error);
        container.innerHTML = "<div class='col-span-full bg-red-800 p-4 rounded'><p class='text-red-200'><i class='fas fa-wifi mr-2'></i>Network error. Please check your connection.</p></div>";
      }
    }

    function handleNewSignal(signal) {
      playNotificationSound();
      
      showNotificationToast(
        `New Signal: ${signal.pair}`,
        `${signal.status} - Entry: ${signal.entry}`,
        'success'
      );
      
      notificationCount++;
      updateNotificationBadge();
      
      if (isNotificationsEnabled) {
        OneSignalDeferred.push(function(OneSignal) {
          OneSignal.Notifications.requestPermission().then(function(permission) {
            if (permission) {
              new Notification(`New Forex Signal: ${signal.pair}`, {
                body: `${signal.status} - Entry: ${signal.entry}`,
                icon: '/icon-192x192.png',
                tag: 'forex-signal'
              });
            }
          });
        });
      }
    }

    function setupRealTimeSubscription() {
      signalsSubscription = client
        .channel('signals_channel')
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'signals' 
        }, (payload) => {
          console.log('New signal received:', payload);
          handleNewSignal(payload.new);
          fetchSignals();
        })
        .subscribe();
    }

    async function updateStatistics() {
      try {
        const { data, error } = await client
          .from('focus')
          .select('*');

        if (error) throw error;

        const total = data.length;
        const today = new Date().toDateString();
        const todaySignals = data.filter(signal => 
          new Date(signal.created_at).toDateString() === today
        ).length;

        const activeSignals = data.filter(signal => 
          signal.status !== 'CLOSED' && signal.status !== 'CANCELLED'
        ).length;

        const successRate = Math.round((data.filter(signal => 
          signal.status === 'CLOSED'
        ).length / Math.max(total, 1)) * 100);

        document.getElementById('activeSignals').textContent = activeSignals;
        document.getElementById('todaySignals').textContent = todaySignals;
        document.getElementById('successRate').textContent = `${successRate}%`;

      } catch (error) {
        console.error('Error updating statistics:', error);
      }
    }

    // Utility Functions
    function formatTime(dateString) {
      return new Date(dateString).toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
      });
    }

    function timeAgo(dateString) {
      const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
      const intervals = [
        { label: 'y', value: 31536000 },
        { label: 'mo', value: 2592000 },
        { label: 'd', value: 86400 },
        { label: 'h', value: 3600 },
        { label: 'm', value: 60 },
      ];
      for (const interval of intervals) {
        const amount = Math.floor(seconds / interval.value);
        if (amount >= 1) return `${amount}${interval.label} ago`;
      }
      return "Just now";
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      const authForm = document.getElementById('authForm');
      const loginForm = document.getElementById('loginForm');
authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const remember = document.getElementById('rememberMe').checked;

        const existingError = authForm.querySelector('.text-red-500');
        if (existingError) existingError.remove();

        const { data, error } = await client.auth.signInWithPassword({ email, password });

        if (error) {
          const formError = document.createElement('p');
          formError.className = "text-red-500 text-sm mt-2";
          formError.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Login failed: ${error.message}`;
          authForm.appendChild(formError);
          return;
        }

        currentUser = data.user;
        if (remember) {
          localStorage.setItem('rememberUser', 'true');
        }

        document.getElementById('userInfo').innerHTML = `<i class="fas fa-user mr-1"></i>Welcome, ${currentUser.email}`;
        loginForm.classList.add('hidden');
        
        if (!localStorage.getItem('notificationPermissionAsked')) {
          document.getElementById('notificationModal').classList.remove('hidden');
          localStorage.setItem('notificationPermissionAsked', 'true');
        } else {
          showDashboard();
        }
      });

      client.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_OUT') {
          localStorage.removeItem('rememberUser');
          cleanupSubscriptions();
          showLoginRequired();
        }

        if (event === 'SIGNED_IN') {
          currentUser = session.user;
          if (localStorage.getItem('rememberUser')) {
            showDashboard();
          }
        }

        if (event === 'TOKEN_REFRESHED') {
          console.log("üîÑ Token refreshed");
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await client.auth.signOut();
        localStorage.removeItem('rememberUser');
        cleanupSubscriptions();
        window.location.reload();
      });

      document.getElementById('enableNotifications').addEventListener('click', async () => {
        const granted = await requestNotificationPermission();
        if (granted) {
          showNotificationToast('Notifications Enabled', 'You will now receive alerts for new signals', 'success');
        }
        showDashboard();
      });

      document.getElementById('skipNotifications').addEventListener('click', () => {
        showDashboard();
      });

      document.getElementById('notificationBell').addEventListener('click', () => {
        if (isNotificationsEnabled) {
          notificationCount = 0;
          updateNotificationBadge();
        } else {
          requestNotificationPermission();
        }
      });

      document.getElementById('refreshSignals').addEventListener('click', () => {
        fetchSignals();
        showNotificationToast('Refreshed', 'Signals updated', 'info');
      });

      document.getElementById('filterStatus').addEventListener('change', () => {
        fetchSignals();
      });

      // Initialize Application
      client.auth.getSession().then(({ data: { session } }) => {
        if (session && session.user && localStorage.getItem('rememberUser')) {
          currentUser = session.user;
          document.getElementById('userInfo').innerHTML = `<i class="fas fa-user mr-1"></i>Welcome, ${currentUser.email}`;
          showDashboard();
        } else {
          document.getElementById('loadingScreen').classList.add('hidden');
          loginForm.classList.remove('hidden');
        }
      });
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser) {
        notificationCount = 0;
        updateNotificationBadge();
      }
    });

    window.addEventListener('beforeunload', cleanupSubscriptions);
  </script>
</body>
</html>         
           